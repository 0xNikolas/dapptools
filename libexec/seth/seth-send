#!/usr/bin/env bash
### seth-send -- sign and publish a transaction to the blockchain
### Usage: seth send [-a] [-f <origin>] [-v <value>] <object> <sig> [<args>]
###    or: seth send [-a] [-f <origin>] [-v <value>] [<object>] [<data>]
###
### Publish a transaction signed by <origin> to call <object> with <data>.
### If no <object> is given, create a new object (initialized from <data>).
###
### If no <origin> is given, fall back to `$SETH_ORIGIN' or `$SETH_FROM'.
### If no <origin> is given at all, just print an error message and exit.
set -e
[[ $1 ]] && object=$(seth --to-address "$1")
[[ $object ]] && jshon+=(-s "$object" -i to)

###
### If <sig> has the form `<name>(<types>)', infer <data> from <sig>/<args>.
### If no <data> is given, read the call data from standard input instead.
### If no <data> is given at all, just call <object> without any call data.
data=$(seth calldata ${2+"${@:2}"})
jshon+=(-s "$data" -i data)

jshon+=($(seth --send-params))
tx=$(seth --jsonrpc eth_sendTransaction -n {} "${jshon[@]}" -i append)

###
### If `-a' is given, then print the transaction hash and exit immediately.
[[ $SETH_ASYNC ]] && exec echo "$tx"

### Otherwise, wait for the transaction receipt and then proceed as follows:
echo >&2 "${0##*/}: $tx"
echo -n >&2 "${0##*/}: Waiting for transaction receipt..."
n=$(SETH_TICK=yes seth receipt "$tx" blockNumber)
echo >&2
echo >&2 "${0##*/}: Transaction included in block $n."

###
### If no <object> is given, print the address of the newly created object.
[[ $object ]] || exec seth receipt "$tx" contractAddress

### If <object> is given, print the inferred return value of the transaction.
### Warning: inferred value may be wrong in case of conflicting transactions.
echo >&2 "${0##*/}: \
warning: return value may be inaccurate (see \`seth send --help')"

# XXX: Inferring the return value of the transaction by performing the
# equivalent call on the previous block can produce incorrect results
# if multiple conflicting transactions are included in the same block.
seth --block="$((n - 1))" call "$@"
